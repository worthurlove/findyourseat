<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šä¼ æµ‹è¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .upload-area { 
            border: 2px dashed #ccc; 
            padding: 20px; 
            text-align: center; 
            margin: 20px 0;
            cursor: pointer;
        }
        .log { 
            background: #f5f5f5; 
            padding: 10px; 
            margin: 10px 0; 
            height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px;
        }
        .status { margin: 10px 0; font-weight: bold; }
    </style>
</head>
<body>
    <h1>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h1>
    <p>è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„æµ‹è¯•é¡µé¢ï¼Œç”¨äºè°ƒè¯•æ–‡ä»¶ä¸Šä¼ é—®é¢˜ã€‚</p>
    
    <div class="status" id="status">å°±ç»ª</div>
    
    <div class="upload-area" id="uploadArea">
        ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°è¿™é‡Œ
        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
    </div>
    
    <div class="log" id="log"></div>
    
    <script src="libs/xlsx.full.min.js"></script>
    <script>
        let isProcessing = false;
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        
        function addLog(message) {
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `[${time}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }
        
        function setStatus(text, color = 'black') {
            status.textContent = text;
            status.style.color = color;
        }
        
        function resetFileInput() {
            const fileInput = document.getElementById('fileInput');
            const oldHandler = fileInput.onchange;
            fileInput.onchange = null;
            fileInput.value = '';
            setTimeout(() => {
                fileInput.onchange = oldHandler;
            }, 100);
            addLog('æ–‡ä»¶è¾“å…¥å·²é‡ç½®');
        }
        
        async function handleFile(file) {
            if (isProcessing) {
                addLog('âš ï¸ æ–‡ä»¶æ­£åœ¨å¤„ç†ä¸­ï¼Œå¿½ç•¥æ–°è¯·æ±‚');
                return;
            }
            
            isProcessing = true;
            setStatus('å¤„ç†ä¸­...', 'orange');
            addLog(`ğŸ“ å¼€å§‹å¤„ç†æ–‡ä»¶: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
            
            try {
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.name.match(/\.(xlsx|xls)$/i)) {
                    throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
                }
                
                if (file.name.toLowerCase().endsWith('.xlsm')) {
                    throw new Error('ä¸æ”¯æŒXLSMæ–‡ä»¶');
                }
                
                // æ¨¡æ‹Ÿå¤„ç†
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // å°è¯•è¯»å–æ–‡ä»¶
                const data = new Uint8Array(await file.arrayBuffer());
                const workbook = XLSX.read(data, { type: 'array' });
                
                addLog(`âœ… æ–‡ä»¶è§£ææˆåŠŸï¼Œå·¥ä½œè¡¨æ•°é‡: ${workbook.SheetNames.length}`);
                
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                addLog(`ğŸ“Š æ•°æ®è¡Œæ•°: ${jsonData.length}`);
                setStatus('å¤„ç†å®Œæˆ', 'green');
                
                // æˆåŠŸåé‡ç½®
                setTimeout(() => {
                    resetFileInput();
                    setStatus('å°±ç»ª', 'black');
                }, 2000);
                
            } catch (error) {
                addLog(`âŒ å¤„ç†å¤±è´¥: ${error.message}`);
                setStatus('å¤„ç†å¤±è´¥', 'red');
                resetFileInput();
                
                setTimeout(() => {
                    setStatus('å°±ç»ª', 'black');
                }, 3000);
            } finally {
                isProcessing = false;
            }
        }
        
        // åˆå§‹åŒ–
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && !isProcessing) {
                addLog(`ğŸ“¤ æ–‡ä»¶é€‰æ‹©äº‹ä»¶è§¦å‘: ${file.name}`);
                handleFile(file);
            }
        });
        
        uploadArea.addEventListener('click', () => {
            if (!isProcessing) {
                addLog('ğŸ–±ï¸ ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ');
                fileInput.click();
            }
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f0f0f0';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.backgroundColor = '';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && !isProcessing) {
                addLog(`ğŸ“¥ æ‹–æ‹½æ–‡ä»¶: ${files[0].name}`);
                handleFile(files[0]);
            }
        });
        
        addLog('ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½');
    </script>
</body>
</html>
